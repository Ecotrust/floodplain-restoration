function resize(){var a=$(window).height(),b=$(window).width(),c=$(window).width();map.onResize(a,b),c>991?(leftPanelResize(a,b),bodyResize(a,b)):$("#map-container").is(":visible")||leftPanelResize(a,b)}function bodyResize(){$("body").css("padding-top",parseInt($("#main-navbar").css("height")))}function leftPanelResize(a){$(".left-panel-column").height(a-53)}var dummydata={type:"FeatureCollection",features:[{geometry:{type:"MultiPolygon",coordinates:[[[[-13693239.7724,5469069.373804],[-13693234.99512,5468730.184491],[-13693163.3354,5468687.188663],[-13692972.242835,5468701.52061],[-13692824.1461,5468610.751635],[-13692661.7174,5468539.091921],[-13692487.3454,5468326.50144],[-13691942.73161,5468297.83755],[-13691534.2712,5468176.016036],[-13690889.333814,5467896.54315],[-13690526.2579,5467552.57652],[-13690330.388,5469446.78163],[-13690509.5373,5469635.485545],[-13690521.4806,5469752.529745],[-13690612.2496,5469833.744087],[-13690951.4389,5469852.85334],[-13692045.4439,5469623.542259],[-13692570.9484,5469465.890889],[-13693010.4613,5469217.47055],[-13693239.7724,5469069.373804]]]]},type:"Feature",id:4,properties:{inputnode_set:[{name:"",date_modified:"2014-10-16T23:33:42.749Z",notes:"",question:1,site:4,value:.3,user:"dummyuser",date_created:"2014-10-16T23:33:42.749Z",id:4}],name:"Willamette Confluence",date_modified:"2014-10-16T23:33:42.686Z",notes:"Notes on Location",user:"dummyuser",date_created:"2014-10-16T23:33:42.686Z",shared_with_public:!1,pit_set:[{geometry:{type:"Polygon",coordinates:[[[-13692100.382981,5469387.0652],[-13691854.351296,5469513.66403],[-13691742.084411,5469535.161945],[-13691715.8092,5469508.886717],[-13691653.704097,5469516.05269],[-13691529.4939,5469461.113574],[-13691295.4055,5469442.00432],[-13690975.325471,5469527.99597],[-13690836.7834,5469523.21866],[-13690841.560671,5469432.44969],[-13692040.6666,5469227.025175],[-13692102.771638,5469317.794146],[-13692100.382981,5469387.0652]]]},type:"Feature",id:6,properties:{surface_area:.5,substrate:.5,name:"testpit",date_modified:"2014-10-16T23:33:42.695Z",pit_depth:.5,notes:"",adjacent_river_depth:.5,site:4,complexity:.5,user:"dummyuser",contamination:.5,date_created:"2014-10-16T23:33:42.695Z",slope_dist:.5,bank_slope:.5,pit_levies:.5,bedrock:.5}},{geometry:{type:"Polygon",coordinates:[[[-13691245.243727,5469207.915918],[-13691008.766671,5469260.46637],[-13691011.1553,5469303.4622],[-13690796.176186,5469339.29206],[-13690774.6783,5469193.583975],[-13691202.2479,5469102.815004],[-13691245.243727,5469207.915918]]]},type:"Feature",id:7,properties:{surface_area:.5,substrate:.5,name:"testpit",date_modified:"2014-10-16T23:33:42.706Z",pit_depth:.5,notes:"",adjacent_river_depth:.5,site:4,complexity:.5,user:"dummyuser",contamination:.5,date_created:"2014-10-16T23:33:42.706Z",slope_dist:.5,bank_slope:.5,pit_levies:.5,bedrock:.5}},{geometry:{type:"Polygon",coordinates:[[[-13691880.626525,5469081.31709],[-13691574.878412,5469141.03352],[-13691584.43304,5469195.972632],[-13691281.073584,5469243.745775],[-13691250.021041,5469090.87172],[-13691856.739953,5468969.0502],[-13691880.626525,5469081.31709]]]},type:"Feature",id:8,properties:{surface_area:.5,substrate:.5,name:"testpit",date_modified:"2014-10-16T23:33:42.724Z",pit_depth:.5,notes:"",adjacent_river_depth:.5,site:4,complexity:.5,user:"dummyuser",contamination:.5,date_created:"2014-10-16T23:33:42.724Z",slope_dist:.5,bank_slope:.5,pit_levies:.5,bedrock:.5}},{geometry:{type:"Polygon",coordinates:[[[-13690836.7834,5469568.60314],[-13690800.9535,5469809.857516],[-13690917.9977,5469821.8008],[-13691457.8342,5469711.922573],[-13691484.10944,5469664.149431],[-13691517.55064,5469659.372116],[-13691562.935126,5469692.81332],[-13692315.3621,5469525.60732],[-13692544.673208,5469442.00432],[-13692585.2804,5469384.676546],[-13692613.944265,5469315.40549],[-13692504.066,5469291.518918],[-13692482.5681,5469315.40549],[-13692499.2887,5469329.737432],[-13692527.952608,5469320.182803],[-13692568.559779,5469334.514746],[-13692511.232008,5469372.73326],[-13692487.3454,5469396.61983],[-13692430.017665,5469358.40132],[-13692363.135266,5469367.955946],[-13692315.3621,5469332.126089],[-13692207.8726,5469377.510575],[-13692315.3621,5469399.00849],[-13692265.200323,5469418.117746],[-13692186.374638,5469391.84252],[-13692019.168638,5469511.27537],[-13691990.5048,5469487.388803],[-13691921.233696,5469535.161945],[-13691887.7925,5469523.21866],[-13691744.473068,5469590.10106],[-13691737.3071,5469563.825831],[-13691711.0319,5469563.825831],[-13691706.2546,5469606.82166],[-13691682.367983,5469602.04434],[-13691684.75664,5469575.76912],[-13691632.2062,5469559.04852],[-13691584.43304,5469508.886717],[-13691417.227041,5469475.44552],[-13691271.519,5469492.166117],[-13691147.308785,5469525.60732],[-13690992.046071,5469578.157774],[-13690939.4956,5469611.59897],[-13690922.775014,5469585.323745],[-13690875.0019,5469585.323745],[-13690853.504,5469575.76912],[-13690836.7834,5469568.60314]]]},type:"Feature",id:9,properties:{surface_area:.5,substrate:.5,name:"testpit",date_modified:"2014-10-16T23:33:42.738Z",pit_depth:.5,notes:"",adjacent_river_depth:.5,site:4,complexity:.5,user:"dummyuser",contamination:.5,date_created:"2014-10-16T23:33:42.738Z",slope_dist:.5,bank_slope:.5,pit_levies:.5,bedrock:.5}}]}},{geometry:{type:"MultiPolygon",coordinates:[[[[-13688321.527395,5468904.556462],[-13687889.180454,5469078.928433],[-13687557.157112,5469138.64486],[-13687275.2956,5469143.42218],[-13686916.997,5468971.438862],[-13686862.057886,5468880.66989],[-13687277.6842,5468601.197006],[-13687664.646683,5468307.392179],[-13688240.313053,5468694.35463],[-13688321.527395,5468904.556462]]]]},type:"Feature",id:5,properties:{inputnode_set:[{name:"",date_modified:"2014-10-16T23:33:42.790Z",notes:"",question:1,site:5,value:.3,user:"dummyuser",date_created:"2014-10-16T23:33:42.790Z",id:5}],name:"Location Two",date_modified:"2014-10-16T23:33:42.763Z",notes:"Notes on Location",user:"dummyuser",date_created:"2014-10-16T23:33:42.763Z",shared_with_public:!1,pit_set:[{geometry:{type:"Polygon",coordinates:[[[-13687518.9386,5468961.88423],[-13687526.1046,5468844.840034],[-13687483.108741,5468739.73912],[-13687246.6317,5468754.07106],[-13687005.3773,5468909.33378],[-13687244.243,5469007.26872],[-13687518.9386,5468961.88423]]]},type:"Feature",id:10,properties:{surface_area:.5,substrate:.5,name:"testpit",date_modified:"2014-10-16T23:33:42.771Z",pit_depth:.5,notes:"",adjacent_river_depth:.5,site:5,complexity:.5,user:"dummyuser",contamination:.5,date_created:"2014-10-16T23:33:42.771Z",slope_dist:.5,bank_slope:.5,pit_levies:.5,bedrock:.5}},{geometry:{type:"Polygon",coordinates:[[[-13688039.6659,5468890.224519],[-13687860.5166,5469019.212],[-13687812.743426,5469007.26872],[-13687772.136254,5468942.774976],[-13687941.7309,5468871.11526],[-13688018.1679,5468868.726605],[-13688039.6659,5468890.224519]]]},type:"Feature",id:11,properties:{surface_area:.5,substrate:.5,name:"testpit",date_modified:"2014-10-16T23:33:42.780Z",pit_depth:.5,notes:"",adjacent_river_depth:.5,site:5,complexity:.5,user:"dummyuser",contamination:.5,date_created:"2014-10-16T23:33:42.780Z",slope_dist:.5,bank_slope:.5,pit_levies:.5,bedrock:.5}}]}},{geometry:{type:"MultiPolygon",coordinates:[[[[-13711567.9386,5505914.41009],[-13711197.696767,5505928.742038],[-13711190.530795,5504970.89053],[-13711233.526624,5504775.020642],[-13711802.027022,5504056.034845],[-13712160.325592,5504438.219986],[-13712141.216335,5504975.66784],[-13712007.4515,5505107.043984],[-13711735.1446,5505338.743726],[-13711589.4365,5505673.155724],[-13711567.9386,5505914.41009]]]]},type:"Feature",id:6,properties:{inputnode_set:[{name:"",date_modified:"2014-10-16T23:33:42.835Z",notes:"",question:1,site:6,value:.3,user:"dummyuser",date_created:"2014-10-16T23:33:42.835Z",id:6}],name:"Location 3",date_modified:"2014-10-16T23:33:42.798Z",notes:"Notes on Location",user:"dummyuser",date_created:"2014-10-16T23:33:42.798Z",shared_with_public:!1,pit_set:[{geometry:{type:"Polygon",coordinates:[[[-13711496.3,5505601.5],[-13711238.3,5505546.6],[-13711219.2,5505484.5],[-13711212,5504968.5],[-13711269.4,5504978.1],[-13711300.4,5504961.3],[-13711481.9,5505011.5],[-13711474.8,5505267.1],[-13711465.2,5505427.1],[-13711503.4,5505458.2],[-13711496.3,5505601.5]]]},type:"Feature",id:12,properties:{surface_area:.5,substrate:.5,name:"testpit",date_modified:"2014-10-16T23:33:42.810Z",pit_depth:.5,notes:"",adjacent_river_depth:.5,site:6,complexity:.5,user:"dummyuser",contamination:.5,date_created:"2014-10-16T23:33:42.810Z",slope_dist:.5,bank_slope:.5,pit_levies:.5,bedrock:.5}},{geometry:{type:"Polygon",coordinates:[[[-13711638.4,5504712.9],[-13711571.5,5504673.5],[-13711585.9,5504648.4],[-13711668.3,5504697.4],[-13711619.3,5504809.7],[-13711558.4,5504901.6],[-13711538.1,5504905.2],[-13711510.6,5504930.3],[-13711497.5,5504962.5],[-13711400.7,5504937.4],[-13711400.7,5504905.2],[-13711437.8,5504882.5],[-13711472.4,5504789.4],[-13711578.7,5504830],[-13711638.4,5504712.9]]]},type:"Feature",id:13,properties:{surface_area:.5,substrate:.5,name:"testpit",date_modified:"2014-10-16T23:33:42.821Z",pit_depth:.5,notes:"",adjacent_river_depth:.5,site:6,complexity:.5,user:"dummyuser",contamination:.5,date_created:"2014-10-16T23:33:42.821Z",slope_dist:.5,bank_slope:.5,pit_levies:.5,bedrock:.5}}]}}]};angular.module("uiApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch"]).config(["$routeProvider","$httpProvider",function(a,b){b.defaults.xsrfHeaderName="X-CSRFToken",b.defaults.xsrfCookieName="csrftoken",a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/sites",{templateUrl:"views/sitelist.html",controller:"SitelistCtrl"}).when("/site/new",{templateUrl:"views/siteedit.html",controller:"SiteeditCtrl"}).when("/site/:siteId",{templateUrl:"views/sitedetail.html",controller:"SitedetailCtrl"}).when("/site/:siteId/edit",{templateUrl:"views/siteedit.html",controller:"SiteeditCtrl"}).when("/site/:siteId/pit/new",{templateUrl:"views/pitedit.html",controller:"PiteditCtrl"}).when("/site/:siteId/pit/:pitId/edit",{templateUrl:"views/pitedit.html",controller:"PiteditCtrl"}).when("/site/:siteId/survey/done",{templateUrl:"views/surveydone.html",controller:"SurveydoneCtrl"}).when("/site/:siteId/survey/:questionId",{templateUrl:"views/survey.html",controller:"SurveyCtrl"}).when("/site/:siteId/report",{templateUrl:"views/report.html",controller:"ReportCtrl"}).when("/help/:topic",{templateUrl:"views/help.html",controller:"HelpCtrl"}).otherwise({templateUrl:"404.html"})}]).run(["$rootScope","ContentFactory",function(a,b){a.content=b.allContent()}]),angular.module("uiApp").factory("SiteFactory",["$rootScope","$http","$window",function(a,b,c){var d={};return d.sites=[],d.suitability={},d.getSites=function(){var a=b.get("/api/site.json");return a.success(function(a){d.sites=a}),a.error(function(){console.log("Could not fetch sites.json")}),a},d.deleteSite=function(a){var c="/api/site/"+a,e=b.delete(c);return e.success(function(){for(var b=d.sites.features.length-1;b>=0;b--){var c=d.sites.features[b];c.id===a&&d.sites.features.splice(b,1)}}),e.error(function(){console.log("Could not DELETE",c)}),e},d.deleteSitePit=function(a,c){for(var e,f="/api/pit/"+c,g=d.sites.features.length-1;g>=0;g--){var h=d.sites.features[g];h.id==a&&(e=g)}var i=b.delete(f);return i.success(function(){for(var a=d.sites.features[e].properties.pit_set.length-1;a>=0;a--){var b=d.sites.features[e].properties.pit_set[a];b.id===c&&d.sites.features[e].properties.pit_set.splice(a,1)}}),i},d.postSite=function(a,d){var e="/api/site";a.geometry=d;var f=b.post(e,a);return f.success(function(){}),f.error(function(a){console.log("ERROR",a),c.alert("Could not create new location. Be sure you have all required fields filled in.")}),f},d.postSitePit=function(a,d,e){var f="/api/pit";d.geometry=e;var g=b.post(f,d);return g.success(function(){}),g.error(function(a){console.log("ERROR",a),c.alert("Could not create new pit. Be sure you have all required fields filled in.")}),g},d.putSite=function(a,d){var e="/api/site/"+a.id;a.geometry=d;var f=b.put(e,a);return f.success(function(){}),f.error(function(a){console.log("ERROR",a),c.alert("Could not update location. Be sure you have all required fields filled in.")}),f},d.putSitePit=function(a,d,e){var f="/api/pit/"+d.id;d.geometry=e;var g=b.put(f,d);return g.success(function(){}),g.error(function(a){console.log("ERROR",a),c.alert("Could not update pit. Be sure you have all required fields filled in.")}),g},d.getSuitabilityScores=function(a){var c="/api/site/"+a+"/suitability.json",e=b.get(c);return e.success(function(a){d.suitability=a}),e.error(function(){console.log("Could not fetch suitability.json")}),e},d}]),angular.module("uiApp").factory("QuestionFactory",["$http",function(a){var b={};return b.questions=[],b.contexts={site:{id:1,label:"Location",components:[{id:10,name:"Pit restorability",question_ids:[]},{id:11,name:"Practical, location-level restorability",question_ids:[1,2,3]}]},socio_economic:{id:2,label:"Socio-Economic",components:[{id:12,name:"Cost benefit",question_ids:[8,9,10]},{id:13,name:"Threat to other areas / permutability",question_ids:[4,5,6,7]}]},landscape:{id:3,label:"Landscape",components:[{id:14,name:"Conservation value",question_ids:[26,27]},{id:15,name:"Biotic conditions",question_ids:[23,24,25]},{id:16,name:"Abiotic conditions",question_ids:[19,20,21,22]},{id:17,name:"Geomorphic controls",question_ids:[11,12,13,14]},{id:18,name:"Floodplain characteristics",question_ids:[15,16,17,18]}]},suitability:{id:4,label:"Overall",components:[]}},b.getQuestions=function(){var c=a.get("/api/questions.json");return c.success(function(a){b.questions=a}),c.error(function(){console.log("Could not fetch questions.json")}),c},b.getContexts=function(){var c=a.get("/api/questions.json");return c.success(function(a){b.questions=a,b.contexts=b.contexts}),c.error(function(){console.log("Could not fetch contexts.")}),c},b}]),angular.module("uiApp").factory("ContentFactory",function(){var a={about:"We are building an online tool that provides an efficient and sound approach to quickly identify whether restoring a former gravel pit mine location is worth the investment of time and money.",title:"Floodplain Gravel Mine Restoration",welcome:"The Floodplain Gravel Mine Restoration Tool",hook:"Informed decision making and resource investment <br> for the restoration of floodplain mining locations.",requirements:'<a class="homepage-link" href="#/help/documents">Before you get started</a>',getStarted:"Get Started",siteListHeader:"All locations",siteCreateDirections:"Click anywhere on the map to start defining your general location boundary. <br/><br/> Continue clicking to complete the shape of your location. <br/><br/> When you're satisfied with your location outline, double-click to end drawing.<br/><br/> Name and save your location when done. You can come back and edit this at any time.",siteEditDirections:"Click and hold anywhere on the location border to grab it. <br/><br/> Drag the section of border to where it belongs.",siteEditDefinitions:'<div class="definition-block blue-text"><p><span class="definition-term">Project</span>: The collection of locations being considered for restoration.</p><p><span class="definition-term">Location</span>: A contiguous plot of land that encompasses one or more pits.</p><p><span class="definition-term">Pit</span>: A single gravel pit mine.</p></div>',pitCreateDirections:"Like drawing your location, click once on the map to begin drawing your pit boundaries. Click again to add additional points. Double-click to finish.",pitEditDirections:"Click and hold anywhere on the pit border to grab it. Drag the section of the border to where it belongs.",previousQuestion:"<< Previous Question",nextQuestion:"Next Question >>",attribution:"This tool is a product of The Nature Conservancy and Ecotrust",documents:'        <h3>Before you get started...</h3>        <h4>Please assemble as many of the following resources as possible:</h4>        <div class="table-container">          <div class="table-row">            <div class="table-cell col-md-12">              <div class="property-box padded-box">                <p class="blue-text document-list-item">Taxlot, land user, easement, access, infrastructure, and other relevant location information.</p>                <hr class="document-list-hr">                <p class="blue-text document-list-item">Any information on existing permits or pit reclaimation requirements</p>                <hr class="document-list-hr">                <p class="blue-text document-list-item">Existing conservation plans, recovery plans, prioritizations, regional priorities</p>                <hr class="document-list-hr">                <p class="blue-text document-list-item">Water rights information</p>                <hr class="document-list-hr">                <p class="blue-text document-list-item">State environment or water quality information</p>                <hr class="document-list-hr">                <p class="blue-text document-list-item">Watershed assessments, sediment budgets, and other available watershed or river research, reports, or data</p>                <hr class="document-list-hr">                <p class="blue-text document-list-item">Ecological assessments, research, reports, or data on species and habitat in the watershed, the reach, or on the location</p>                <hr class="document-list-hr">                <p class="blue-text document-list-item">Reasonable estimates of both pit depth and river thalweg</p>              </div>            </div>            <div class="col-md-1 table-cell survey-nav-col">              <a href="#/">                <p class="survey-nav survey-nav-forward">                  <span class="glyphicon glyphicon-play survey-nav-icon"></span>                </p>              </a>            </div>'};return{allContent:function(){return a},getContent:function(b){return a[b]},get:function(a){return this.getContent(a)}}}),angular.module("uiApp").config(["$httpProvider",function(a){a.responseInterceptors.push("myHttpInterceptor");var b=function(a){return a};a.defaults.transformRequest.push(b)}]).factory("myHttpInterceptor",["$q","$window",function(a){return function(b){return b.then(function(a){return window.setTimeout(resize,1),a},function(b){return window.setTimeout(resize,1),a.reject(b)})}}]);var map;angular.module("uiApp").controller("MainCtrl",["$scope","$rootScope",function(a,b){b.activeSiteId=null,map.showMap(!1)}]);var map;angular.module("uiApp").controller("SitelistCtrl",["$scope","$rootScope","$window","SiteFactory","QuestionFactory","NodeFactory",function(a,b,c,d,e,f){function g(b){f.getNodes(a.sites[b].id).then(function(){a.sites[b].nodeCount=f.nodes.length})}b.userName||(c.alert("You are not logged in. You will now be redirected to the login page."),c.location="/accounts/login/"),map.showMap(!0),a.sites=[],b.activeSiteId=null,a.numQuestions=0,d.getSites().then(function(){a.sites=d.sites.features,map.clear(),map.loadSites(d.sites),map.showMap(!0);for(var b in a.sites)g(b)}),e.getQuestions().then(function(){a.numQuestions=e.questions.length}),a.deleteSite=function(b){c.confirm("Delete this location? Are you sure?")===!0&&d.deleteSite(b).then(function(){a.sites=d.sites.features,map.clear(),map.loadSites(d.sites)})},a.toggleCircleIconClass=function(a){var b=document.getElementById(a);b.className=b.classList.contains("glyphicon-plus-sign")?b.className.replace(/\bglyphicon-plus-sign\b/,"glyphicon-minus-sign"):b.className.replace(/\bglyphicon-minus-sign\b/,"glyphicon-plus-sign")}}]);var map;angular.module("uiApp").controller("SitedetailCtrl",["$scope","$routeParams","$rootScope","$window","SiteFactory","QuestionFactory","NodeFactory",function(a,b,c,d,e,f,g){var h=parseInt(b.siteId,10);c.activeSiteId=h,c.userName||(d.alert("You are not logged in. You will now be redirected to the login page."),d.location="/accounts/login/"),map.showMap(!0),a.surveyPrompt="Begin Survey",a.sites=[],a.site={},a.firstUnansweredId=1,e.getSites().then(function(){a.sites=e.sites.features;for(var b=e.sites.features.length-1;b>=0;b--){var c=e.sites.features[b];c.id===h&&(a.site=c)}map.clear(),map.loadSites({type:"FeatureCollection",features:[a.site]}),map.loadPits({type:"FeatureCollection",features:a.site.properties.pit_set}),map.showMap(!0)}),f.getQuestions().then(function(){a.questions=f.questions,a.questions.sort(function(a,b){return a.order-b.order}),a.firstUnansweredId=a.questions[0].id,g.getNodes(c.activeSiteId).then(function(){var b=g.nodes;if(b.length>0){a.surveyPrompt="Continue Survey";for(var c in a.questions){var d=!1;for(var e in b)if(b[e].question===a.questions[c].id){d=!0;break}if(d===!1){a.firstUnansweredId=a.questions[c].id;break}}}map.showMap(!0)})}),a.deleteSitePit=function(b,c){d.confirm("Delete this pit? Are you sure?")===!0&&e.deleteSitePit(b,c).then(function(){a.sites=e.sites.features;for(var b=e.sites.features.length-1;b>=0;b--){var c=e.sites.features[b];c.id===h&&(a.site=c)}map.loadPits({type:"FeatureCollection",features:a.site.properties.pit_set})})}}]);var map;angular.module("uiApp").controller("SiteeditCtrl",["$scope","$routeParams","$location","$rootScope","$window","$sce","ContentFactory","SiteFactory",function(a,b,c,d,e,f,g,h){d.userName||(e.alert("You are not logged in. You will now be redirected to the login page."),e.location="/accounts/login/"),a.siteEditDirections=f.trustAsHtml(g.get("siteCreateDirections")),a.siteEditDefinitions=f.trustAsHtml(g.get("siteEditDefinitions")),a.title="Creating A New Location",map.showMap(!0),a.sites=[],a.site={};var i,j,k=!1;void 0===b.siteId?(i=null,k=!0,j={id:"",type:"Feature",geometry:{},properties:{}}):i=parseInt(b.siteId,10),d.activeSiteId=i,h.getSites().then(function(){if(a.sites=h.sites.features,map.clear(),k)map.loadSites({type:"FeatureCollection",features:[]}),map.addSite(j);else{for(var b=h.sites.features.length-1;b>=0;b--){var c=h.sites.features[b];c.id===i&&(a.site=c,a.title='Editing <span class="label label-info">'+c.properties.name+"</span>",a.siteEditDirections=f.trustAsHtml(g.get("siteEditDirections")))}map.loadSites({type:"FeatureCollection",features:[a.site]}),map.editSite()}map.showMap(!0)}),a.$on("activeFeatureWKT",function(b,c){a.site.geometry=c}),a.save=function(){console.log("spinner on");try{var b=map.getActiveSiteWkt();k?h.postSite(a.site,b).then(function(){console.log("spinner off (POST new location complete!)"),c.path("/sites")}):h.putSite(a.site,b).then(function(){console.log("spinner off (PUT existing location complete!)"),c.path("/sites")})}catch(d){console.log(d),e.alert("Please draw the boundaries for your location.")}}}]);var map;angular.module("uiApp").controller("PiteditCtrl",["$scope","$routeParams","$rootScope","$location","$window","$sce","ContentFactory","SiteFactory",function(a,b,c,d,e,f,g,h){c.userName||(e.alert("You are not logged in. You will now be redirected to the login page."),e.location="/accounts/login/"),map.showMap(!0),a.pitEditDirections=f.trustAsHtml(g.get("pitEditDirections"));var i=parseInt(b.siteId,10);c.activeSiteId=i,a.activePitId=!1;var j,k=!1;a.pitFormObj={form:[{question:"Name",visible:!0,id:"name",order:0,type:"text",answers:[]},{question:"Is hazardous waste present?",visible:!0,id:"contamination",order:10,type:"select",answers:[{label:"I don't know",value:.5},{label:"No, definitely not.",value:1},{label:"No, I don’t think so",value:.8},{label:"Yes, but I do not know if it can be remediated.",value:.4},{label:"Yes, and the cost and effort to remediate it is acceptable.",value:.2},{label:"Yes, and it will be expensive and/or very difficult to remediate.",value:0}]},{question:"Substrate",visible:!1,id:"substrate",order:20,type:"select",answers:[{label:"Unknown",value:.5},{label:"Good",value:1},{label:"Bad",value:0}]},{question:"How much deeper is the pit than the adjacent river thalweg?",visible:!0,id:"adjacent_river_depth",order:30,type:"select",answers:[{label:"I don't know",value:.5},{label:"Much deeper than pit (good?)",value:1},{label:"A little deeper than pit",value:.8},{label:"About the same as pit",value:.6},{label:"A little shallower than pit",value:.3},{label:"Much shallower than pit (bad?)",value:0}]},{question:"What is the distance from the river to the pit edge?",visible:!0,id:"slope_dist",order:40,type:"select",answers:[{label:"I don't know",value:.5},{label:"Short (< 20 ft.)",value:1},{label:"Medium (20-80 ft.)",value:.6},{label:"Long (> 80ft.)",value:0}]},{question:"Are there any pit-adjacent levees?",visible:!0,id:"pit_levies",order:50,type:"select",answers:[{label:"I don't know",value:.5},{label:"Yes (Good?)",value:1},{label:"No (Bad?)",value:0}]},{question:"Bedrock",visible:!1,id:"bedrock",order:60,type:"select",answers:[{label:"Unknown",value:.5},{label:"Yes (Good?)",value:1},{label:"No (Bad?)",value:0}]},{question:"Select the answer that best describes the slope of the pit bank:",visible:!0,id:"bank_slope",order:70,type:"select",answers:[{label:"I don't know",value:.5},{label:"The bank slope is very shallow around most of the pit. (Good?)",value:1},{label:"The bank slope is a mix of steep and shallow.",value:.51},{label:"The bank slope is steep around most of the pit. (Bad?)",value:0}]},{question:"Pit Depth",visible:!1,id:"pit_depth",order:80,type:"select",answers:[{label:"Unknown",value:.5},{label:"Shallower than river (Good?)",value:1},{label:"About the same",value:.6},{label:"Deeper than river (Bad?)",value:0}]},{question:"What is the surface area of the pit?",visible:!0,id:"surface_area",order:90,type:"select",answers:[{label:"I don't know",value:.5},{label:"< 1 acre",value:1},{label:"> 1 acre",value:0}]},{question:"How complex is the perimeter of the pit?",visible:!0,id:"complexity",order:100,type:"select",answers:[{label:"I don't know",value:.5},{label:"Simple",value:1},{label:"Complex",value:0}]},{question:"Notes",visible:!0,id:"notes",order:110,type:"textarea",answers:[]}]},void 0===b.pitId?(a.pitEditDirections=f.trustAsHtml(g.get("pitCreateDirections")),k=!0,j={id:"",type:"Feature",geometry:{},properties:{notes:"",name:"<new pit>",site:i,contamination:.5,substrate:.5,adjacent_river_depth:.5,slope_dist:.5,pit_levies:.5,bedrock:.5,bank_slope:.5,pit_depth:.5,surface_area:.5,complexity:.5}}):a.activePitId=parseInt(b.pitId,10),a.pit={},a.site={},a.sites=[],h.getSites().then(function(){a.sites=h.sites.features;for(var b=h.sites.features.length-1;b>=0;b--){var c=h.sites.features[b];c.id===i&&(a.site=c)}if(map.clear(),map.loadSites({type:"FeatureCollection",features:[a.site]}),k)a.pit=j,map.loadPits({type:"FeatureCollection",features:[]}),map.addPit();else{for(var d=a.site.properties.pit_set.length-1;d>=0;d--){var e=a.site.properties.pit_set[d];e.id===a.activePitId&&(a.pit=e)}map.loadPits({type:"FeatureCollection",features:[a.pit]}),map.editPit()}map.showMap(!0)});var l=!1;("new"===b.pitId||null===a.pit)&&(l=!0,a.pit={id:"",type:"Feature",geometry:{},properties:{}}),a.$on("activeFeatureWKT",function(b,c){a.pit.geometry=c}),a.save=function(){console.log("spinner on");try{var b=map.getActivePitWkt;k?h.postSitePit(i,a.pit,b()).then(function(){console.log("spinner off"),d.path("/site/"+i)}):h.putSitePit(i,a.pit,map.getActivePitWkt()).then(function(){console.log("spinner off"),d.path("/site/"+i)})}catch(c){console.log(c),e.alert("No Pit Drawn")}}}]);var map;angular.module("uiApp").controller("SurveyCtrl",["$scope","$routeParams","$rootScope","$location","$window","SiteFactory","QuestionFactory","NodeFactory",function(a,b,c,d,e,f,g,h){c.userName||(alert("You are not logged in. You will now be redirected to the login page."),e.location="/accounts/login/"),map.showMap(!0);var i=parseInt(b.questionId,10);c.activeSiteId=b.siteId;var j=[];a.question={},a.numQuestions=j.length;var k=999,l=0,m=[];a.node={notes:"",site:c.activeSiteId,question:i,value:null},a.numNodes=0,a.nodeVal=null,a.nodeNotes=null,a.newNode=!0,g.getQuestions().then(function(){j=g.questions,a.numQuestions=j.length,k=j[j.length-1].id;for(var b=g.questions.length-1;b>=0;b--){var c=g.questions[b];c.id===i&&(a.question=c)}map.showMap(!0)}),h.getNodes(c.activeSiteId).then(function(){m=h.nodes,a.numNodes=m.length;for(var b=h.nodes.length-1;b>=0;b--){var d=h.nodes[b];d.question===i&&d.site===parseInt(c.activeSiteId,10)&&(a.node=d,a.nodeVal=d.value,a.nodeNotes=d.notes,a.newNode=!1)}map.showMap(!0)}),a.showPrev=!0,a.showPrev=!0,a.submitForm=function(){for(var b=!1,e=document.getElementById("pitForm").elements,f=0;f<e.length;f++)"radio"==e[f].type&&e[f].checked&&(b=!0);if(null!==a.nodeVal&&b){var g=a.nextQuestion();a.node.value=a.nodeVal,a.node.notes=a.nodeNotes,a.newNode?h.postNode(a.node).then(function(){d.path("site/"+c.activeSiteId+"/survey/"+g)}):h.putNode(a.node).then(function(){d.path("site/"+c.activeSiteId+"/survey/"+g)})}else alert('Please answer the question before moving on. If you are unable to answer the question, select "Not Sure".')},a.nextQuestion=function(){var b=i+1;return a.showNext=!0,b>a.numQuestions?(b=k,a.showNext=!0,"done"):b},a.prevQuestion=function(){var b=i-1;return a.showPrev=!0,l>b&&(b=l,a.showPrev=!1),b},a.toggleCircleIconClass=function(a){var b=document.getElementById(a);b.className=b.classList.contains("glyphicon-plus-sign")?b.className.replace(/\bglyphicon-plus-sign\b/,"glyphicon-minus-sign"):b.className.replace(/\bglyphicon-minus-sign\b/,"glyphicon-plus-sign")}}]);var map,d3;angular.module("uiApp").controller("SurveydoneCtrl",["$scope","$routeParams","$rootScope","$window","SiteFactory","QuestionFactory",function(a,b,c,d,e,f){c.userName||(d.alert("You are not logged in. You will now be redirected to the login page."),d.location="/accounts/login/"),map.showMap(!0);var g=[];c.activeSiteId=b.siteId,e.getSuitabilityScores(b.siteId).then(function(){c.suitability=e.suitability;var a=[],b={low:{minScore:0,maxScore:33,label:"Unsuitable","class":"unsuitable"},med:{minScore:33,maxScore:66,label:"Moderately Suitable","class":"moderately-suitable"},high:{minScore:66,maxScore:100,label:"Highly Suitable","class":"highly-suitable"}},d={site:"Location",socio_economic:"Socio-Economic",landscape:"Landscape",suitability:"Overall"};for(var f in d)a.push({key:f,value:Math.floor(100*e.suitability[f])});var g=d3.select(".suitability-scores").selectAll("div").data(a).enter().append("div").attr("class","suitability-score"),h=g.append("p");h.append("span").attr("class","suitability-label").text(function(a){return d[a.key]+": "}),h.append("span").attr("class","suitability-rank").text(function(a){for(var c in b){var d=b[c];if(a.value<=d.maxScore&&a.value>=d.minScore)return d.label}return console.log("no label for "+a.key),null}),g.append("div").attr("class",function(a){for(var c in b){var d=b[c];if(a.value<=d.maxScore&&a.value>=d.minScore)return"suitability-bar "+d.class}return"suitability-bar"}).style("width",function(a){return a.value+"%"}).text(function(a){return a.value})}),a.maxQuestionId=2,f.getQuestions().then(function(){g=f.questions,a.numQuestions=g.length,a.maxQuestionId=g[g.length-1].id,map.showMap(!0)}),a.alert=function(a){d.alert(a)}}]);var map;angular.module("uiApp").controller("ReportCtrl",["$scope","$rootScope","$window","$routeParams","SiteFactory","QuestionFactory","NodeFactory",function(a,b,c,d,e,f,g){function h(a){for(var b in k){var c=k[b];if(a<=c.maxScore&&a>=c.minScore)return c.label}return null}function i(a){for(var b in k){var c=k[b];if(a<=c.maxScore&&a>=c.minScore)return c.class}return"transparent"}function j(){for(var c in l){var d=100*b.suitability[c];a.contexts[c].score=d,a.contexts[c].rank=h(d),a.contexts[c].bgColorClass=i(d)}}b.userName||(c.alert("You are not logged in. You will now be redirected to the login page."),c.location="/accounts/login/"),map.showMap(!1),a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"],b.activeSiteId=d.siteId,a.pits=[],a.answers={};var k={low:{minScore:0,maxScore:33,label:"Unsuitable","class":"unsuitable"},med:{minScore:33,maxScore:66,label:"Moderately Suitable","class":"moderately-suitable"},high:{minScore:66,maxScore:100,label:"Highly Suitable","class":"highly-suitable"}},l={site:"Location",socio_economic:"Socio-Economic",landscape:"Landscape",suitability:"Overall"};
a.contextList=["site","socio_economic","landscape","suitability"],a.contexts={site:{id:1,label:"Location",components:[{id:10,name:"Pit restorability",question_ids:[]},{id:11,name:"Practical, location-level restorability",question_ids:[1,2,3]}]},socio_economic:{id:2,label:"Socio-Economic",components:[{id:12,name:"Cost benefit",question_ids:[8,9,10]},{id:13,name:"Threat to other areas / permutability",question_ids:[4,5,6,7]}]},landscape:{id:3,label:"Landscape",components:[{id:14,name:"Conservation value",question_ids:[26,27]},{id:15,name:"Biotic conditions",question_ids:[23,24,25]},{id:16,name:"Abiotic conditions",question_ids:[19,20,21,22]},{id:17,name:"Geomorphic controls",question_ids:[11,12,13,14]},{id:18,name:"Floodplain characteristics",question_ids:[15,16,17,18]}]},suitability:{id:4,label:"Overall",components:[]}},e.getSites().then(function(){a.sites=e.sites.features;for(var c=e.sites.features.length-1;c>=0;c--){var d=e.sites.features[c];if(d.id===parseInt(b.activeSiteId,10)){a.site=d,a.pits=d.properties.pit_set;break}}}),a.maxQuestionId=2;var m=[],n=[];f.getQuestions().then(function(){m=f.questions,a.numQuestions=m.length,a.maxQuestionId=m[m.length-1].id;for(var c=0;c<m.length;c++)a.answers[m[c].id]=m[c],a.answers[m[c].id].value=!1,a.answers[m[c].id].notes=!1,a.answers[m[c].id].answer=!1;g.getNodes(b.activeSiteId).then(function(){n=g.nodes,a.numNodes=n.length;for(var c=0;c<n.length;c++){a.answers[n[c].question].value=n[c].value,a.answers[n[c].question].notes=n[c].notes;var d=a.answers[n[c].question].choices;for(var f in d)d[f].value===n[c].value&&(a.answers[n[c].question].answer=d[f].choice)}e.getSuitabilityScores(b.activeSiteId).then(function(){b.suitability=e.suitability,j()})}),map.showMap(!1)}),a.alert=function(a){c.alert(a)},a.toggleCircleIconClass=function(a){var b=document.getElementById(a);b.className=b.classList.contains("glyphicon-plus-sign")?b.className.replace(/\bglyphicon-plus-sign\b/,"glyphicon-minus-sign"):b.className.replace(/\bglyphicon-minus-sign\b/,"glyphicon-plus-sign")},a.selectComponent=function(a){var b=document.getElementById(a);b.className=b.classList.contains("report-component-selected")?b.className.replace(/\breport-component-selected\b/,""):b.className+" report-component-selected"}}]);var map;angular.module("uiApp").controller("HelpCtrl",["$scope","$routeParams","$rootScope","$sce","ContentFactory",function(a,b,c,d,e){a.text=d.trustAsHtml(e.get(b.topic)),a.topic=b.topic,c.activeSiteId=null,map.showMap(!1)}]),angular.module("uiApp").controller("NavCtrl",["$scope","$rootScope","$window","$location","SiteFactory","QuestionFactory",function(a,b,c,d,e,f){a.sites=[],a.site={properties:{name:null}},b.$watch("activeSiteId",function(){a.site={properties:{name:null}},b.userName&&e.getSites().then(function(){a.sites=e.sites.features;for(var c=e.sites.features.length-1;c>=0;c--){var d=e.sites.features[c];d.id===parseInt(b.activeSiteId,10)&&(a.site=d)}})}),a.questions=[],a.questionsObj={},a.contexts=[],f.getQuestions().then(function(){a.questions=f.questions;for(var b in a.questions)a.questionsObj[a.questions[b].id.toString()]=a.questions[b];a.contexts=f.contexts}),a.href=function(a){d.path(a)},a.link=function(a){c.location=a}}]),angular.module("uiApp").filter("digits",function(){return function(a){return 10>a&&(a="0"+a),a}}),angular.module("uiApp").filter("percentage",["$filter",function(a){return function(b,c){return a("number")(100*b,c)+"%"}}]);var map={site:{},pit:{}};map.styleEditable=function(){return[new ol.style.Style({stroke:new ol.style.Stroke({color:"blue",width:2}),fill:new ol.style.Fill({color:"rgba(55, 55, 255, 0.4)"})})]},map.pit.style=function(){return[new ol.style.Style({stroke:new ol.style.Stroke({color:"white",width:2}),fill:new ol.style.Fill({color:"rgba(255, 255, 100, 0.1)"})})]},map.site.style=function(){return[new ol.style.Style({stroke:new ol.style.Stroke({color:"white",lineDash:[4],width:2}),fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"})})]},map.loadSites=function(a){return a&&"FeatureCollection"===a.type?(map.map.removeLayer(map.site.layer),map.site.source=new ol.source.GeoJSON({object:a}),map.site.layer=new ol.layer.Vector({source:map.site.source,style:map.site.style}),map.map.addLayer(map.site.layer),void map.map.getView().fitExtent(map.site.source.getExtent(),map.map.getSize())):(console.log("ERROR in data supplied to map.loadSites:",a),!1)},map.loadPits=function(a){return a&&"FeatureCollection"===a.type?(map.map.removeLayer(map.pit.layer),map.pit.source=new ol.source.GeoJSON({object:a}),map.pit.layer=new ol.layer.Vector({source:map.pit.source,style:map.pit.style}),void map.map.addLayer(map.pit.layer)):(console.log("ERROR in data supplied to map.loadPits:",a),!1)},map.clear=function(){map.map.removeInteraction(map.drawPit),map.map.removeInteraction(map.drawSite),map.map.removeInteraction(map.modifyPit),map.map.removeInteraction(map.modifySite),map.map.removeLayer(map.pit.layer),map.map.removeLayer(map.site.layer)},map.wktFormat=new ol.format.WKT,map.editSite=function(){map.modifySite=new ol.interaction.Modify({features:new ol.Collection(map.site.source.getFeatures()),deleteCondition:function(a){return ol.events.condition.shiftKeyOnly(a)&&ol.events.condition.singleClick(a)}}),map.map.addInteraction(map.modifySite),map.site.layer.setStyle(map.styleEditable)},map.editPit=function(){map.modifyPit=new ol.interaction.Modify({features:new ol.Collection(map.pit.source.getFeatures()),deleteCondition:function(a){return ol.events.condition.shiftKeyOnly(a)&&ol.events.condition.singleClick(a)}}),map.map.addInteraction(map.modifyPit),map.map.getView().fitExtent(map.pit.source.getExtent(),map.map.getSize()),map.pit.layer.setStyle(map.styleEditable)},map.addSite=function(){map.drawSite=new ol.interaction.Draw({source:map.site.source,type:"MultiPolygon"}),map.drawSite.on("drawstart",function(){map.site.source.clear()}),map.drawSite.on("drawend",function(){}),map.map.addInteraction(map.drawSite),map.site.layer.setStyle(map.styleEditable)},map.addPit=function(){map.drawPit=new ol.interaction.Draw({source:map.pit.source,type:"Polygon"}),map.drawPit.on("drawstart",function(){map.pit.source.clear()}),map.drawPit.on("drawend",function(){}),map.map.addInteraction(map.drawPit),map.pit.layer.setStyle(map.styleEditable)},map.getActiveSiteWkt=function(){var a=map.site.source.getFeatures(),b=a[0].getGeometry(),c=map.wktFormat.writeGeometry(b);return c},map.getActivePitWkt=function(){var a=map.pit.source.getFeatures(),b=a[0].getGeometry(),c=map.wktFormat.writeGeometry(b);return c},map.map=new ol.Map({target:"map",layers:[new ol.layer.Tile({source:new ol.source.MapQuest({layer:"sat"})})],view:new ol.View({center:ol.proj.transform([-122,44],"EPSG:4326","EPSG:3857"),zoom:7})}),map.onResize=function(a){$(".map-container").height(a-51),map.map.updateSize()},$(window).resize(resize),$(document).ready(function(){window.setTimeout(resize,1)}),map.showMap=function(a){a?($("#map-container").show(),$("#left-container").removeClass("col-md-12"),$("#map-container").addClass("col-md-6"),$("#left-container").addClass("col-md-6")):($("#map-container").removeClass("col-md-6"),$("#map-container").hide(),$("#left-container").removeClass("col-md-6"),$("#left-container").addClass("col-md-12"))},angular.module("uiApp").factory("NodeFactory",["$http",function(a){var b={};return b.nodes=[],b.getNodes=function(c){var d=a.get("/api/node?format=json&site="+c);return d.success(function(a){b.nodes=a}),d.error(function(){console.log("Could not fetch questions.json")}),d},b.postNode=function(c){var d=a.post("/api/node",c);return d.success(function(a){b.status=a}),d.error(function(a){b.status=a,console.log("Could not create new node -- Error: "+a)}),d},b.putNode=function(c){var d=a.put("/api/node/"+c.id,c);return d.success(function(a){b.status=a}),d.error(function(a){b.status=a,console.log("Could not update node id: "+c.id+" -- Error: "+a)}),d},b}]);