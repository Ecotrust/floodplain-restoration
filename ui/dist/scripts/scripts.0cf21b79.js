"use strict";angular.module("uiApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/sites",{templateUrl:"views/sitelist.html",controller:"SitelistCtrl"}).when("/site/new",{templateUrl:"views/siteedit.html",controller:"SiteeditCtrl"}).when("/site/:siteId",{templateUrl:"views/sitedetail.html",controller:"SitedetailCtrl"}).when("/site/:siteId/edit",{templateUrl:"views/siteedit.html",controller:"SiteeditCtrl"}).when("/site/:siteId/pit/new",{templateUrl:"views/pitedit.html",controller:"PiteditCtrl"}).when("/site/:siteId/pit/:pitId/edit",{templateUrl:"views/pitedit.html",controller:"PiteditCtrl"}).when("/site/:siteId/survey/done",{templateUrl:"views/surveydone.html",controller:"SurveydoneCtrl"}).when("/site/:siteId/survey/:questionId",{templateUrl:"views/survey.html",controller:"SurveyCtrl"}).when("/site/:siteId/report",{templateUrl:"views/report.html",controller:"ReportCtrl"}).when("/help/:topic",{templateUrl:"views/help.html",controller:"HelpCtrl"}).otherwise({templateUrl:"404.html"})}]).run(["$rootScope","ContentFactory",function(a,b){a.content=b.allContent()}]),angular.module("uiApp").factory("SiteFactory",["$rootScope",function(a){var b,c,d=[{id:2,type:"Feature",properties:{name:"Willamette Confluence",pit_set:[{id:2,type:"Feature",geometry:{coordinates:[[[-13658685.458334716,5653282.611971635],[-13654710.732863888,5665206.788384127],[-13639423.327206852,5663678.047818419],[-13639423.327206852,5648084.894048248],[-13658685.458334716,5653282.611971635]]],type:"Polygon"},properties:{user:"dummyuser",name:"testpit",notes:"",date_created:"2014-09-29T20:13:17.927Z",date_modified:"2014-09-29T20:13:17.927Z",site:2,contamination:.5,substrate:.5,adjacent_river_depth:.5,slope_dist:.5,pit_levies:.5,bedrock:.5,bank_slope:.5,pit_depth:.5,surface_area:.5,complexity:.5}},{id:3,type:"Feature",geometry:{coordinates:[[[-13680087.826254565,5619038.823299875],[-13679782.078141425,5631574.495938646],[-13667857.901728937,5633103.23650435],[-13667857.901728937,5616287.090281615],[-13680087.826254565,5619038.823299875]]],type:"Polygon"},properties:{user:"dummyuser",name:"another testpit",notes:"",date_created:"2014-09-29T20:13:17.927Z",date_modified:"2014-09-29T20:13:17.927Z",site:2,contamination:.5,substrate:.5,adjacent_river_depth:.5,slope_dist:.5,pit_levies:.5,bedrock:.5,bank_slope:.5,pit_depth:.5,surface_area:.5,complexity:.5}}],inputnode_set:[{user:"dummyuser",id:2,name:"",notes:"",date_created:"2014-09-29T20:13:17.938Z",date_modified:"2014-09-29T20:13:17.938Z",site:2,question:1,value:.3}]},geometry:{coordinates:[[[[-13692317.750780193,5650225.130840228],[-13684674.047951676,5694864.355358774],[-13621689.936644692,5674684.979891483],[-13631168.128152054,5585100.782741257],[-13713414.370586902,5593967.47802234],[-13692317.750780193,5650225.130840228]]]],type:"MultiPolygon"}},{id:4,type:"Feature",properties:{name:"Another Site",pit_set:[{id:2,type:"Feature",geometry:{coordinates:[[[-13758685.458334716,5653282.611971635],[-13754710.732863888,5665206.788384127],[-13739423.327206852,5663678.047818419],[-13739423.327206852,5648084.894048248],[-13758685.458334716,5653282.611971635]]],type:"Polygon"},properties:{user:"dummyuser",name:"testpit",notes:"",date_created:"2014-09-29T20:13:17.927Z",date_modified:"2014-09-29T20:13:17.927Z",site:2,contamination:.5,substrate:.5,adjacent_river_depth:.5,slope_dist:.5,pit_levies:.5,bedrock:.5,bank_slope:.5,pit_depth:.5,surface_area:.5,complexity:.5}}],inputnode_set:[{user:"dummyuser",id:2,name:"",notes:"",date_created:"2014-09-29T20:13:17.938Z",date_modified:"2014-09-29T20:13:17.938Z",site:2,question:1,value:.3}]},geometry:{coordinates:[[[[-13792317,5650225],[-13784674,5694864],[-13721689,5674684],[-13739423,5585100],[-13813414,5593967],[-13792317,5650225]]]],type:"MultiPolygon"}}];return{getSites:function(){return d},getSitesCollection:function(){return{type:"FeatureCollection",features:d}},getPitsCollection:function(){var a=this.getActiveSite();return{type:"FeatureCollection",features:a.properties.pit_set}},setActivePitId:function(b){c=parseInt(b,10);var d=this.getSitePit(b);("undefined"==typeof d||null===typeof d)&&console.log("ERROR - can not edit pit "+b+"... does not exist"),a.$broadcast("activePitChanged",{})},getActivePit:function(){return this.getSitePit(c)},getActivePitCollection:function(){var a=this.getSitePit(c);return{type:"FeatureCollection",features:[a]}},getActivePitId:function(){return c},getSitePit:function(a){a=parseInt(a,10);for(var b=this.getActiveSite(),c=b.properties.pit_set.length-1;c>=0;c--)if(b.properties.pit_set[c].id===a)return b.properties.pit_set[c];return null},getSuitabilityScores:function(){var a={site:.27260624999999994,landscape:.46898395525146463,suitability:.43765438899978504,socio_economic:.43198437499999986};return a},setActiveSiteId:function(c){c=parseInt(c,10),c!==b&&(a.$broadcast("activeSiteChanged",{}),b=c);var d=this.getActiveSite();d?(a.activeSiteId=d.id,a.activeSiteName=d.properties.name):(b=null,a.activeSiteId=null,a.activeSiteName=null)},getActiveSite:function(){for(var a=d.length-1;a>=0;a--)if(d[a].id===b)return d[a];return null},getActiveSiteId:function(){return b},getActiveSiteCollection:function(){return{type:"FeatureCollection",features:[this.getActiveSite()]}}}}]),angular.module("uiApp").factory("QuestionFactory",function(){var a=[{layers:[],id:1,name:"fill_material_availability",title:"Property Information",question:"Is the property for sale at or below fair market value?",detail:"Detail about Fill material availability",order:100,category:"Property Information",image:"",supplement:"",choices:[{choice:"available",value:1},{choice:"Not Sure",value:.5},{choice:"unavailable",value:0}]},{layers:[],id:2,name:"q2",title:"",question:"Are there recent or continuing impacts from contaminated sites upstream or adjacent to your property, within the river reach?",detail:"Additional info and resources",order:100,category:"Water Quality",image:"",supplement:"",choices:[{choice:"suitable",value:1},{choice:"Not Sure",value:.5},{choice:"unsuitable",value:0}]}];return{getQuestion:function(b){for(var c=a.length-1;c>=0;c--)if(a[c].id===b)return a[c]},minId:function(){return 1},maxId:function(){return 2}}}),angular.module("uiApp").factory("ContentFactory",function(){var a={about:"We are building an online tool that provides an efficient and sound approach to quickly identify whether restoring a former gravel pit mine property is worth the investment of time and money.",title:"Floodplain Gravel Mine Restoration",welcome:"The Floodplain Gravel Mine Restoration Tool",hook:"Informed decision making and resource investment <br> for the restoration of floodplain mining sites.",getStarted:"Get Started",siteListHeader:"Select a property to evaluate",previousQuestion:"<< Previous Question",nextQuestion:"Next Question >>"};return{allContent:function(){return a},getContent:function(b){return a[b]},get:function(a){return this.getContent(a)}}}),angular.module("uiApp").controller("MainCtrl",["$scope","$rootScope",function(a,b){b.showMap=!1,b.siteId=null,b.siteName=null}]),angular.module("uiApp").controller("SitelistCtrl",["$scope","$rootScope","SiteFactory",function(a,b,c){b.showMap=!0,a.sites=c.getSites(),b.siteId=null,b.siteName=null,map.clear(),map.loadSites(c.getSitesCollection())}]),angular.module("uiApp").controller("SitedetailCtrl",["$scope","$routeParams","$rootScope","SiteFactory",function(a,b,c,d){c.showMap=!0,d.setActiveSiteId(b.siteId),a.site=d.getActiveSite(),a.deleteSite=function(a){console.log("Deleted site "+a)},a.deleteSitePit=function(a,b){console.log("Deleted pit "+b+" from site "+a)},map.clear(),map.loadSites(d.getActiveSiteCollection()),map.loadPits(d.getPitsCollection())}]),angular.module("uiApp").controller("SiteeditCtrl",["$scope","$routeParams","$rootScope","SiteFactory",function(a,b,c,d){c.showMap=!0,d.setActiveSiteId(b.siteId);var e=d.getActiveSite(),f=!1;("new"===b.siteId||null===e)&&(f=!0,e={id:"",type:"Feature",geometry:{},properties:{}}),a.site=e,a.$on("activeFeatureWKT",function(b,c){a.site.geometry=c}),a.save=function(){console.log(f?"POST new Site":"PUT edited Site"),console.log("New geometry is ",map.getActiveSiteWkt()),console.log("Save site "+a.site.id),console.log("spinner on"),console.log("If AJAX call is a success, update the SiteFactory singleton"),console.log("spinner off")},map.clear(),f?(map.loadSites({type:"FeatureCollection",features:[]}),map.addSite()):(map.loadSites(d.getActiveSiteCollection()),map.editSite())}]),angular.module("uiApp").controller("PiteditCtrl",["$scope","$routeParams","$rootScope","SiteFactory",function(a,b,c,d){c.showMap=!0,d.setActiveSiteId(b.siteId);var e=d.getActiveSite();a.site=e,d.setActivePitId(b.pitId);var f=d.getSitePit(b.pitId);a.pit=f;var g=!1;("new"===b.pitId||null===f)&&(g=!0,a.pit={id:"",type:"Feature",geometry:{},properties:{}}),a.$on("activeFeatureWKT",function(b,c){a.pit.geometry=c}),a.save=function(){console.log(g?"POST new Pit":"PUT edited Pit"),console.log("New geometry is ",map.getActivePitWkt()),console.log("Save Pit "+a.pit.id),console.log("spinner on"),console.log("If AJAX call is a success, update the SiteFactory singleton"),console.log("spinner off")},map.clear(),map.loadSites(d.getActiveSiteCollection()),g?(map.loadPits({type:"FeatureCollection",features:[]}),map.addPit()):(map.loadPits(d.getActivePitCollection()),map.editPit())}]),angular.module("uiApp").controller("SurveyCtrl",["$scope","$routeParams","$rootScope","SiteFactory","QuestionFactory",function(a,b,c,d,e){c.showMap=!0;var f=parseInt(b.questionId,10);a.siteId=b.siteId,a.question=e.getQuestion(f);var g=e.maxId(),h=e.minId();a.showPrev=!0,a.showPrev=!0,a.nextQuestion=function(){var b=f+1;return a.showNext=!0,b>g?(b=g,a.showNext=!0,"done"):b},a.prevQuestion=function(){var b=f-1;return a.showPrev=!0,h>b&&(b=h,a.showPrev=!1),b}}]),angular.module("uiApp").controller("SurveydoneCtrl",["$scope","$routeParams","$rootScope","SiteFactory",function(a,b,c,d){c.showMap=!0,a.siteId=b.siteId,a.suitability=d.getSuitabilityScores(b.siteId)}]),angular.module("uiApp").controller("ReportCtrl",["$scope","$rootScope",function(a,b){b.showMap=!0,a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("uiApp").controller("HelpCtrl",["$scope","$routeParams","$rootScope","ContentFactory",function(a,b,c,d){c.showMap=!1,a.text=d.get(b.topic),a.topic=b.topic}]),angular.module("uiApp").filter("digits",function(){return function(a){return 10>a&&(a="0"+a),a}}),angular.module("uiApp").filter("percentage",["$filter",function(a){return function(b,c){return a("number")(100*b,c)+"%"}}]);var map={site:{},pit:{}};map.styleEditable=function(){return[new ol.style.Style({stroke:new ol.style.Stroke({color:"blue",width:2}),fill:new ol.style.Fill({color:"rgba(55, 55, 255, 0.4)"})})]},map.loadSites=function(a){return a&&"FeatureCollection"===a.type?(map.map.removeLayer(map.site.layer),map.site.source=new ol.source.GeoJSON({object:a}),map.site.style=function(){return[new ol.style.Style({stroke:new ol.style.Stroke({color:"black",lineDash:[3],width:1}),fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"})})]},map.site.layer=new ol.layer.Vector({source:map.site.source,style:map.site.style}),map.map.addLayer(map.site.layer),void map.map.getView().fitExtent(map.site.source.getExtent(),map.map.getSize())):(console.log("ERROR in data supplied to map.loadSites:",a),!1)},map.loadPits=function(a){return a&&"FeatureCollection"===a.type?(map.map.removeLayer(map.pit.layer),map.pit.source=new ol.source.GeoJSON({object:a}),map.pit.style=function(){return[new ol.style.Style({stroke:new ol.style.Stroke({color:"black",width:1}),fill:new ol.style.Fill({color:"rgba(255, 255, 100, 0.4)"})})]},map.pit.layer=new ol.layer.Vector({source:map.pit.source,style:map.pit.style}),void map.map.addLayer(map.pit.layer)):(console.log("ERROR in data supplied to map.loadPits:",a),!1)},map.clear=function(){map.map.removeInteraction(map.drawPit),map.map.removeInteraction(map.drawSite),map.map.removeInteraction(map.modifyPit),map.map.removeInteraction(map.modifySite),map.map.removeLayer(map.pit.layer),map.map.removeLayer(map.site.layer)},map.wktFormat=new ol.format.WKT,map.editSite=function(){map.modifySite=new ol.interaction.Modify({features:new ol.Collection(map.site.source.getFeatures()),deleteCondition:function(a){return ol.events.condition.shiftKeyOnly(a)&&ol.events.condition.singleClick(a)}}),map.map.addInteraction(map.modifySite),map.site.layer.setStyle(map.styleEditable)},map.editPit=function(){map.modifyPit=new ol.interaction.Modify({features:new ol.Collection(map.pit.source.getFeatures()),deleteCondition:function(a){return ol.events.condition.shiftKeyOnly(a)&&ol.events.condition.singleClick(a)}}),map.map.addInteraction(map.modifyPit),map.map.getView().fitExtent(map.pit.source.getExtent(),map.map.getSize()),map.pit.layer.setStyle(map.styleEditable)},map.addSite=function(){map.drawSite=new ol.interaction.Draw({source:map.site.source,type:"MultiPolygon"}),map.drawSite.on("drawstart",function(){map.site.source.clear()}),map.drawSite.on("drawend",function(){console.log("drawing ended... TODO start editing")}),map.map.addInteraction(map.drawSite),map.site.layer.setStyle(map.styleEditable)},map.addPit=function(){map.drawPit=new ol.interaction.Draw({source:map.pit.source,type:"Polygon"}),map.drawPit.on("drawstart",function(){console.log("clearing drawing"),map.pit.source.clear()}),map.drawPit.on("drawend",function(){console.log("drawing ended... TODO start editing")}),map.map.addInteraction(map.drawPit),map.pit.layer.setStyle(map.styleEditable)},map.getActiveSiteWkt=function(){var a=map.site.source.getFeatures(),b=a[0].getGeometry(),c=map.wktFormat.writeGeometry(b);return c},map.getActivePitWkt=function(){var a=map.pit.source.getFeatures(),b=a[0].getGeometry(),c=map.wktFormat.writeGeometry(b);return c},map.map=new ol.Map({target:"map",layers:[new ol.layer.Tile({source:new ol.source.MapQuest({layer:"osm"})})],view:new ol.View({center:ol.proj.transform([-122,44],"EPSG:4326","EPSG:3857"),zoom:7})}),map.onResize=function(){{var a=$(window).height();$(window).width()}$(".map-container").height(a-51),map.map.updateSize()},$(window).resize(map.onResize),map.onResize();